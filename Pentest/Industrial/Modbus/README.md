## Theory
This protocol is build upon model a request and replay model! The focus will be on modbus over TCP/IP!

|-------------------|-----------------------|
|MBAP               |PDU                    |
|-------------------|-----------------------|
|                   |                       |
|-------------------|-----------------------|
|                   |                       |
|-------------------|-----------------------|

## Simulate a Modbus Server

Library pyModbus is used in order to achieve this task!
Official documentation and stuff is here: https://pymodbus.readthedocs.io/en/latest/index.html

#### 1. Install dependencies

```
$ sudo apt-get install python-pip
$ sudo -H pip install cryptography awscli pyModbus
```

#### 2. Script to start the server

```python
#!/usr/bin/env python
# Pymodbus Asynchronous Server Example

# import the various server implementations 
from pymodbus.server.async import StartTcpServer
from pymodbus.server.async import StartUdpServer
from pymodbus.server.async import StartSerialServer

from pymodbus.device import ModbusDeviceIdentification
from pymodbus.datastore import ModbusSequentialDataBlock
from pymodbus.datastore import ModbusSlaveContext, ModbusServerContext
from pymodbus.transaction import ModbusRtuFramer, ModbusAsciiFramer

# configure the service logging
import logging
logging.basicConfig()
log = logging.getLogger()
log.setLevel(logging.DEBUG)

store = ModbusSlaveContext(
    di = ModbusSequentialDataBlock(0, [17]*100),	# Discrete inputs initializer
    co = ModbusSequentialDataBlock(0, [17]*100),	# Coild initializer
    hr = ModbusSequentialDataBlock(0, [17]*100),	# Holding register initializer
    ir = ModbusSequentialDataBlock(0, [17]*100))	# Input registers initializer
context = ModbusServerContext(slaves=store, single=True)

# initialize the server information
identity = ModbusDeviceIdentification()
identity.VendorName  = 'Pymodbus'
identity.ProductCode = 'PM'
identity.VendorUrl   = 'http://github.com/bashwork/pymodbus/'
identity.ProductName = 'Pymodbus Server'
identity.ModelName   = 'Pymodbus Server'
identity.MajorMinorRevision = '1.0'
 
# run the server you want 

# Modbus over Ethernet via IP
StartTcpServer(context, identity=identity, address=("localhost", 502))
#StartUdpServer(context, identity=identity, address=("127.0.0.1", 502))

# Serial
#StartSerialServer(context, identity=identity, port='/dev/pts/3', framer=ModbusRtuFramer)
#StartSerialServer(context, identity=identity, port='/dev/pts/3', framer=ModbusAsciiFramer)
```
Save as: *python_server.py*

Original script: https://pymodbus.readthedocs.io/en/latest/examples/asynchronous-server.html

#### 3. Start modbus server:
```$ sudo python modbus_server.py```

## Modbus clients